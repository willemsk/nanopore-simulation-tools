# justfile for APBS electrostatics calculations
# Configuration is loaded from params.env
# Override parameters from command line: just pqrs PH_VALUES="7.0 7.4"
#
# Main recipes:
#   just all       - Run complete workflow (pqrs → inputs → apbs)
#   just pqrs      - Generate PQR files from PDB structures
#   just inputs    - Prepare APBS run directories
#   just apbs      - Execute APBS calculations
#   just validate  - Check output completeness and correctness
#   just resume    - Re-run incomplete or failed calculations
#   just clean     - Remove all generated outputs
#
# See README.md for detailed usage instructions

# --- Load configuration from params.env ---
set dotenv-path := "params.env"
set dotenv-load := true
set dotenv-required := true

# ---- Map environment variables (loaded from params.env) into justfile variables ---
PDB_INPUT_DIR   := env("PDB_INPUT_DIR")
OUTPUT_DIR      := env("OUTPUT_DIR")
USERFF          := env("USERFF")
USERNAMES       := env("USERNAMES")
APBS_DUMMY_TEMPLATE := env("APBS_DUMMY_TEMPLATE")
APBS_SOLV_TEMPLATE  := env("APBS_SOLV_TEMPLATE")
PDIE            := env("PDIE")
SDIE            := env("SDIE")
IONR            := env("IONR")
IONC_VALUES     := env("IONC_VALUES")
PH_VALUES       := env("PH_VALUES")
ZMEM            := env("ZMEM")
LMEM            := env("LMEM")
MDIE            := env("MDIE")
MEMV            := env("MEMV")
R_TOP           := env("R_TOP")
R_BOTTOM        := env("R_BOTTOM")
GCENT           := env("GCENT")
GRID_L          := env("GRID_L")
GRID_S          := env("GRID_S")
DIME_L          := env("DIME_L")
DIME_S          := env("DIME_S")
VERBOSE         := env("VERBOSE")

# --- Paths to executables and scripts (resolved at runtime) ---
PDB2PQR_BIN     := `which pdb2pqr30`
APBS_BIN        := `which apbs`
DRAW_BIN        := `realpath ../../bin/draw_membrane2`
PDB2PQR_SCRIPT  := `realpath ../../scripts/electrostatics/run_pdb2pqr.sh`
APBS_SCRIPT     := `realpath ../../scripts/electrostatics/run_apbs.sh`
HELPERS_SCRIPT  := `realpath ../../scripts/electrostatics/workflow_helpers.sh`
VALIDATE_SCRIPT := `realpath ../../scripts/electrostatics/validate_output.sh`

# --- Derived paths ---
PQR_OUTPUT_DIR  := OUTPUT_DIR / "pqr"
APBS_OUTPUT_DIR := OUTPUT_DIR / "apbs_runs"

# --- Main recipes ---

# Default recipe: run the full pipeline.
default: all

# Run the full pipeline sequentially.
all: pqrs inputs apbs

# Validate output completeness and correctness
validate:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Check if validate script exists and is executable
    if [ ! -x '{{VALIDATE_SCRIPT}}' ]; then
        chmod +x '{{VALIDATE_SCRIPT}}'
    fi
    
    # Build verbose flag
    verbose_flag=""
    if [ "{{VERBOSE}}" = "true" ]; then
        verbose_flag="-v"
    fi
    
    echo "=== Validating APBS outputs ==="
    '{{VALIDATE_SCRIPT}}' -o '{{OUTPUT_DIR}}' ${verbose_flag}

# # Resume incomplete or failed APBS calculations
# resume:
#     #!/usr/bin/env bash
#     set -euo pipefail
    
#     # Source helper functions
#     source '{{HELPERS_SCRIPT}}'
#     export CONFIG_FILE="params.env"
    
#     # Check if APBS output directory exists
#     if [ ! -d '{{APBS_OUTPUT_DIR}}' ]; then
#         echo "Error: No APBS output directory found at {{APBS_OUTPUT_DIR}}" >&2
#         echo "Run 'just inputs' and 'just apbs' first." >&2
#         exit 1
#     fi
    
#     echo "=== Checking for incomplete APBS calculations ==="
    
#     # Find all run directories
#     run_dirs=( $(find '{{APBS_OUTPUT_DIR}}' -mindepth 1 -maxdepth 1 -type d | sort) )
#     n_total=${#run_dirs[@]}
    
#     if [ ${n_total} -eq 0 ]; then
#         echo "No APBS run directories found."
#         exit 0
#     fi
    
#     # Identify incomplete directories (missing pot_Lm.dx or pot_Sm.dx)
#     incomplete_dirs=()
#     for dir in "${run_dirs[@]}"; do
#         if [ ! -f "${dir}/pot_Lm.dx" ] || [ ! -f "${dir}/pot_Sm.dx" ]; then
#             incomplete_dirs+=("${dir}")
#         fi
#     done
    
#     n_incomplete=${#incomplete_dirs[@]}
    
#     if [ ${n_incomplete} -eq 0 ]; then
#         echo "All ${n_total} directories appear complete."
#         echo "Run 'just validate' for detailed validation."
#         exit 0
#     fi
    
#     echo "Found ${n_incomplete} incomplete directories (out of ${n_total} total)."
#     echo ""
    
#     # Re-run APBS for incomplete directories
#     verbose_flag=""
#     if [ "{{VERBOSE}}" = "true" ]; then
#         verbose_flag="-v"
#     fi
    
#     for dir in "${incomplete_dirs[@]}"; do
#         dir_name=$(basename "${dir}")
#         echo "Re-running APBS for: ${dir_name}"
        
#         # Re-execute APBS workflow for this directory
#         # This requires running the same steps as in the apbs recipe
#         apbs_dummy_in="${dir}/apbs_dummy.in"
#         apbs_solv_in="${dir}/apbs_solv.in"
        
#         if [ ! -f "${apbs_dummy_in}" ] || [ ! -f "${apbs_solv_in}" ]; then
#             echo "  Skipping ${dir_name}: Missing input files. Run 'just inputs' first."
#             continue
#         fi
        
#         # Run using the same function pattern as run_apbs.sh
#         # For simplicity, call the full script on just this directory pattern
#         # This is a bit inefficient but ensures consistency
#         dir_pattern="${dir%/}"
#         '{{APBS_SCRIPT}}' -b '{{APBS_BIN}}' -m '{{DRAW_BIN}}' -d "${dir_pattern}" ${verbose_flag} || {
#             echo "  Warning: APBS execution failed for ${dir_name}"
#             echo "  Check ${dir}/apbs_*.out for error details"
#         }
#     done
    
#     echo ""
#     echo "=== Resume complete ==="
#     echo "Run 'just validate' to check results."

# Stage 1: Generate PQR files from PDBs. Override: just pqrs PH_VALUES="7.0 7.4"
pqrs PH_VALUES=PH_VALUES:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Source helper functions
    source '{{HELPERS_SCRIPT}}'
    export CONFIG_FILE="params.env"
    
    # Dependency check: PDB files
    if ! check_pdb_files '{{PDB_INPUT_DIR}}'; then
        echo "Skipping PQR generation."
        exit 0
    fi
    
    # Build PDB2PQR arguments
    pdb2pqr_args="--log-level=INFO --userff={{USERFF}} --usernames={{USERNAMES}} --whitespace"
    verbose_flag=""
    if [ "{{VERBOSE}}" = "true" ]; then
        verbose_flag="-v"
    fi
    
    # Process each pH value
    for ph in {{PH_VALUES}}; do
        echo "=== Running PDB2PQR at pH=${ph} ==="
        '{{PDB2PQR_SCRIPT}}' -b '{{PDB2PQR_BIN}}' \
                          -i '{{PDB_INPUT_DIR}}' \
                          -o '{{PQR_OUTPUT_DIR}}' \
                          -p "${ph}" \
                          -q "${pdb2pqr_args}" \
                          ${verbose_flag}
    done
    echo "=== PDB2PQR conversion complete ==="

# Stage 2: Prepare APBS input files from PQR files. Override: just inputs IONC_VALUES="0.10 0.15"
inputs IONC_VALUES=IONC_VALUES:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Source helper functions
    source '{{HELPERS_SCRIPT}}'
    export CONFIG_FILE="params.env"
    
    # Dependency check: PQR files
    if ! check_pqr_files '{{PQR_OUTPUT_DIR}}'; then
        echo "Run 'just pqrs' first. Skipping input preparation."
        exit 0
    fi
    
    # Validate templates
    validate_templates '{{APBS_DUMMY_TEMPLATE}}' '{{APBS_SOLV_TEMPLATE}}' || true
    
    # Get list of PQR files
    pqr_files=( $(find '{{PQR_OUTPUT_DIR}}' -type f -name "*.pqr" 2>/dev/null) )
    
    # Process each PQR file × ion concentration combination
    echo "=== Preparing ABPS input files ==="
    for pqrfile in "${pqr_files[@]}"; do
        pqr=$(basename "$pqrfile" .pqr)
        for ionc in {{IONC_VALUES}}; do
            printf "  Preparing input for ${pqr} at ${ionc} M salt ... "
            outdir="{{APBS_OUTPUT_DIR}}/${pqr}_${ionc}M"
            mkdir -p "${outdir}"
            
            create_apbs_input '{{APBS_DUMMY_TEMPLATE}}' "${outdir}/apbs_dummy.in" ${ionc}
            create_draw_input "${outdir}/draw_membrane.in" ${ionc}
            create_apbs_input '{{APBS_SOLV_TEMPLATE}}' "${outdir}/apbs_solv.in" ${ionc}
            
            cp "${pqrfile}" "${outdir}/TM.pqr"
            printf "done.\n"
        done
    done
    echo "=== Input preparation complete ==="

# Stage 3: Run APBS calculations.
apbs:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Source helper functions
    source '{{HELPERS_SCRIPT}}'
    
    # Dependency check: APBS run directories
    if ! check_apbs_dirs '{{APBS_OUTPUT_DIR}}'; then
        echo "Run 'just inputs' first. Skipping APBS calculations."
        exit 0
    fi
    
    # Build verbose flag
    verbose_flag=""
    if [ "{{VERBOSE}}" = "true" ]; then
        verbose_flag="-v"
    fi
    
    echo "=== Running APBS calculations ==="
    '{{APBS_SCRIPT}}' -b '{{APBS_BIN}}' -m '{{DRAW_BIN}}' -d '{{APBS_OUTPUT_DIR}}' ${verbose_flag}
    echo "=== APBS calculations complete ==="


# --- Cleaning recipes ---

# Clean all generated outputs
clean:
    @echo "Cleaning all output files..."
    @rm -rf '{{OUTPUT_DIR}}'

# Clean only PQR files
clean-pqrs:
    @echo "Cleaning PQR files..."
    @rm -rf '{{PQR_OUTPUT_DIR}}'

# Clean only APBS run directories
clean-inputs:
    @echo "Cleaning APBS run directories..."
    @rm -rf '{{APBS_OUTPUT_DIR}}'

# Alias for clean-inputs
clean-apbs: clean-inputs
